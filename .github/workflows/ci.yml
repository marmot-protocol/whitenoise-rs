name: CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick checks that fail fast
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.90.0"
          components: rustfmt

      - name: Format check
        run: cargo fmt --all -- --config format_code_in_doc_comments=true --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.90.0"
          components: clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Clippy check
        run: cargo clippy --all-targets --all-features --no-deps -- -D warnings -A clippy::uninlined_format_args

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.90.0"

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Documentation check
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: "-D warnings"

  # Security audit
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Security audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Skip advisories:
          # - RUSTSEC-2023-0071: RSA Marvin Attack (transitive via sqlx-mysql, not used in our SQLite-only app)
          # - RUSTSEC-2024-0384: instant unmaintained (transitive via rust-nostr, low risk)
          # - RUSTSEC-2026-0002: lru unsound (transitive via nostr-sdk, awaiting upstream fix)
          ignore: RUSTSEC-2023-0071,RUSTSEC-2024-0384,RUSTSEC-2026-0002

  # Build and test matrix
  test:
    name: Test (${{ matrix.os }})
    permissions:
      contents: read
      pull-requests: write # Required for PR coverage comments
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            run-integration: true
          - os: macos-latest
            run-integration: false
          - os: macos-14
            run-integration: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.90.0"

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}

      - name: Install cargo-llvm-cov (Linux)
        if: runner.os == 'Linux'
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config

      - name: Start Docker Compose services (Linux)
        if: runner.os == 'Linux'
        run: docker compose up -d

      - name: Wait for services to be ready (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Running Nostr health checks..."
          sleep 5
          echo "Checking if services are running:"
          docker compose ps
          echo "Checking relay logs for startup issues:"
          echo "=== nostr-rs-relay logs ==="
          docker compose logs nostr-rs-relay
          echo "=== strfry-nostr-relay logs ==="
          docker compose logs strfry-nostr-relay
          echo "Testing basic HTTP connectivity first:"
          curl -v http://localhost:8080/ || echo "nostr-rs-relay HTTP failed"
          curl -v http://localhost:7777/ || echo "strfry HTTP failed"
          echo "Testing WebSocket connectivity:"
          ./scripts/wait_for_relays.sh

      - name: Check
        run: cargo check --all-targets --all-features

      - name: Build
        run: cargo build --all-targets --all-features

      - name: Test with Coverage (Linux only - requires Docker)
        if: runner.os == 'Linux'
        run: |
          # Exclude test infrastructure, integration tests, and benchmarks from coverage.
          # These inflate the line count without measuring library code quality.
          IGNORE_REGEX='(integration_tests/|bin/integration_test\.rs|bin/benchmark_test\.rs)'

          # Clean and run tests with coverage (library only, no integration-tests feature)
          cargo llvm-cov clean --workspace
          cargo llvm-cov --workspace --all-targets \
            --ignore-filename-regex "$IGNORE_REGEX" \
            --lcov --output-path lcov.info

          # Also run doc tests (without coverage - requires nightly for coverage)
          cargo test --workspace --doc

          # Generate HTML and summary for artifacts
          mkdir -p coverage
          cargo llvm-cov report --ignore-filename-regex "$IGNORE_REGEX" \
            --html --output-dir coverage/html
          cargo llvm-cov report --ignore-filename-regex "$IGNORE_REGEX" \
            | tee coverage/summary.txt

          echo ""
          echo "=== Coverage Summary ==="
          cat coverage/summary.txt
        env:
          RUST_LOG: error

      - name: Extract coverage percentage
        if: matrix.run-integration
        id: coverage
        run: |
          chmod +x scripts/extract-coverage.sh
          COVERAGE=$(./scripts/extract-coverage.sh lcov.info)
          echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
          echo "Current coverage: $COVERAGE%"

      - name: Get master branch coverage (for PRs)
        if: matrix.run-integration && github.event_name == 'pull_request'
        id: master_coverage
        run: |
          echo "ðŸ” Searching for baseline from master branch..."

          # Get the latest completed CI workflow run ID from master
          RUN_ID=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow=ci.yml \
            --branch master \
            --status completed \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "baseline=0" >> "$GITHUB_OUTPUT"
            echo "âš ï¸  No completed CI run found on master"
            exit 0
          fi

          echo "Found workflow run ID: $RUN_ID"

          # Download the baseline artifact
          if gh run download "$RUN_ID" \
            --repo ${{ github.repository }} \
            --name coverage-baseline \
            --dir master-coverage; then

            if [ -f master-coverage/coverage-baseline.txt ]; then
              MASTER_COV=$(cat master-coverage/coverage-baseline.txt)
              echo "baseline=$MASTER_COV" >> "$GITHUB_OUTPUT"
              echo "âœ“ Master branch coverage: $MASTER_COV%"
            else
              echo "baseline=0" >> "$GITHUB_OUTPUT"
              echo "âš ï¸  Baseline file not found in artifact"
            fi
          else
            echo "baseline=0" >> "$GITHUB_OUTPUT"
            echo "âš ï¸  Failed to download baseline artifact"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Compare coverage
        if: matrix.run-integration && github.event_name == 'pull_request' && steps.master_coverage.outputs.baseline != '0'
        run: |
          CURRENT=${{ steps.coverage.outputs.percentage }}
          BASELINE=${{ steps.master_coverage.outputs.baseline }}

          # Allow small fluctuations (up to 0.5%) to avoid false failures from
          # non-deterministic LLVM instrumentation and async test timing.
          THRESHOLD=0.5

          echo "=== Coverage Comparison ==="
          echo "Master branch: $BASELINE%"
          echo "This PR:       $CURRENT%"
          echo "Threshold:     -${THRESHOLD}% allowed"

          # Rounded values for display only
          DIFF=$(awk "BEGIN {printf \"%.2f\", $CURRENT - $BASELINE}")
          DROP=$(awk "BEGIN {printf \"%.2f\", $BASELINE - $CURRENT}")

          # Threshold checks use full-precision awk expressions to avoid
          # rounding masking small regressions (e.g. 0.504% rounding to 0.50%).
          if (( $(awk "BEGIN {print (($BASELINE - $CURRENT) > $THRESHOLD)}") )); then
            echo "Coverage decreased by ${DROP}% (exceeds ${THRESHOLD}% threshold)"
            echo "::error::Coverage regression: $BASELINE% -> $CURRENT% (-${DROP}%, threshold: -${THRESHOLD}%)"
            exit 1
          elif (( $(awk "BEGIN {print ($CURRENT < $BASELINE)}") )); then
            echo "Coverage decreased by ${DROP}% (within ${THRESHOLD}% threshold)"
          elif (( $(awk "BEGIN {print ($CURRENT > $BASELINE)}") )); then
            echo "Coverage improved by +$DIFF%"
          else
            echo "Coverage unchanged at $BASELINE%"
          fi

      - name: Comment PR with coverage
        if: always() && matrix.run-integration && github.event_name == 'pull_request' && steps.master_coverage.outputs.baseline != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const current = parseFloat('${{ steps.coverage.outputs.percentage }}');
            const baseline = parseFloat('${{ steps.master_coverage.outputs.baseline }}');
            const diff = (current - baseline).toFixed(2);
            const threshold = 0.5;
            const sha = context.sha.substring(0, 7);
            const now = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            let emoji, status;
            if (diff > 0) {
              emoji = ':white_check_mark:';
              status = 'improved';
            } else if (diff < -threshold) {
              emoji = ':x:';
              status = `decreased (exceeds -${threshold}% threshold)`;
            } else if (diff < 0) {
              emoji = ':warning:';
              status = `decreased (within -${threshold}% threshold)`;
            } else {
              emoji = ':white_check_mark:';
              status = 'unchanged';
            }

            const sign = diff > 0 ? '+' : '';

            // Extract history from the existing comment if it exists
            const marker = '<!-- coverage-report -->';
            const historyStart = '<!-- coverage-history -->';
            const historyEnd = '<!-- /coverage-history -->';

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existing = comments.find(c => c.body && c.body.includes(marker));

            let historyEntries = [];
            if (existing) {
              const hStart = existing.body.indexOf(historyStart);
              const hEnd = existing.body.indexOf(historyEnd);
              if (hStart !== -1 && hEnd !== -1) {
                const historyBlock = existing.body.substring(
                  hStart + historyStart.length, hEnd
                );
                // Extract existing bullet points
                historyEntries = historyBlock
                  .split('\n')
                  .filter(line => line.trim().startsWith('- '));
              }
            }

            // Add current run to history
            historyEntries.push(
              `- \`${sha}\` ${now} â€” **${current}%** (${sign}${diff}% vs base)`
            );

            const body = [
              `## ${emoji} Coverage Report`,
              '',
              `| Metric | Value |`,
              `|--------|-------|`,
              `| **Base** (master) | ${baseline}% |`,
              `| **This PR** | ${current}% |`,
              `| **Change** | ${sign}${diff}% |`,
              `| **Threshold** | -${threshold}% |`,
              `| **Status** | ${status} |`,
              '',
              '<details>',
              '<summary>History</summary>',
              '',
              historyStart,
              ...historyEntries,
              historyEnd,
              '',
              '</details>',
              '',
              marker,
            ].join('\n');

            if (existing) {
              await github.rest.issues.updateComment({
                comment_id: existing.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            }

      - name: Integration Test
        if: matrix.run-integration
        run: |
          mkdir -p ./dev/data/integration_test/
          RUST_LOG=warn,sqlx=info,refinery_core=error,keyring=info,nostr_relay_pool=error,mdk_sqlite_storage=error,tungstenite=error,integration_test=debug \
          cargo run --bin integration_test --features integration-tests -- \
          --data-dir ./dev/data/integration_test/ --logs-dir ./dev/data/integration_test/
          rm -rf ./dev/data/integration_test/

      - name: Save coverage baseline (master only)
        if: matrix.run-integration && github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          mkdir -p coverage-baseline
          echo "${{ steps.coverage.outputs.percentage }}" > coverage-baseline/coverage-baseline.txt
          echo "Saved baseline: ${{ steps.coverage.outputs.percentage }}%"

      - name: Upload coverage baseline (master only)
        if: matrix.run-integration && github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-baseline
          path: coverage-baseline/coverage-baseline.txt
          retention-days: 90

      - name: Upload HTML coverage report
        if: matrix.run-integration
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: coverage/html/
          retention-days: 90

      - name: Upload lcov coverage report
        if: matrix.run-integration
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-lcov
          path: lcov.info
          retention-days: 90

      - name: Upload coverage summary
        if: matrix.run-integration
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage/summary.txt
          retention-days: 90

      - name: Stop Docker Compose services (Linux)
        if: always() && runner.os == 'Linux'
        run: docker compose down -v

  # Test against nightly (informational only)
  nightly:
    name: Nightly Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: nightly

      - name: Check with nightly
        run: cargo check --all-targets --all-features
